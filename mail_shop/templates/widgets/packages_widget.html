<h2>Package List</h2>
<input id="package-filter" type="text" placeholder="Type to filter">
<form id="package-list-form" name="claim-packages" method="post">
    {% csrf_token %}
    <ul id="package-list">
    {% for package in packages %}
        <li class="package-list-item" >
            <input type="checkbox" name="package" value="{{ package.id }}">
            <a href="{% url 'package_view' package.id %}">{{ package }}</a>
        </li>
    {% endfor %}
    </ul>
    <div id="pin-form" style="display:none;" title="Enter customer PIN">
        <input type="password" id="pin" autocomplete="off">
        <input type="submit" name="claim-packages" tabindex="-1" value="Submit" >
    </div>
    <button id="claim-button" type="button" >Claim</button>
</form>
<script>
    var claimedPackages = [];
    function titleCase(val){
        return val.charAt(0).toUpperCase()+val.substr(1).toLowerCase();
    }
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    var csrftoken = getCookie('csrftoken');
    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });
    $("#package-filter").keyup(function() {
        filterValue = titleCase($("#package-filter").val());
        if(filterValue == '')
            $('.package-list-item').show();
        else{
            $('.package-list-item:not(:contains(' + filterValue + '))').hide();
            $('.package-list-item:contains(' + filterValue + ')').show();
        }
    });
    $('.package-list-item > input').change(function(){
        var packageID = $(this).val();
        if($(this).is(':checked')){
            claimedPackages.push(packageID);
        } else {
            claimedPackages = jQuery.grep(claimedPackages, function(value) {
                return value != packageID;
            });
        }
    });
    $("#claim-button").click(function(){
        $("#pin-form").dialog({modal: true});
    });
    $("#package-list-form").submit(function(event){
        var pin = $("#pin").val();
        console.log(pin);
        $.ajax({
            type: 'POST',
            url: 'packages/claim',
            data: {
                claimed_packages: claimedPackages,
                pin: pin,
            },
        });
    });
</script>
